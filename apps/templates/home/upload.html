{% extends 'layouts/base-fullscreen.html' %}
{% block title %}Analyse de trafic r√©seau - SafeNet IDS{% endblock title %}

{% block stylesheets %}
<!-- Mode sombre - Styles complets pour upload.html -->
<style>
  /* Mode sombre - Body et background */
  body.dark-version {
    background: #1a1f2e !important;
    color: #ffffff !important;
  }

  body.dark-version .main-content {
    background: #1a1f2e !important;
  }

  /* Mode sombre - Cards - Surcharge des styles inline */
  body.dark-version .card {
    background-color: #404B69 !important;
    color: #f8f9fa !important;
    border: 1px solid rgba(255,255,255,0.1) !important;
  }

  body.dark-version .card[style*="background-color: var(--bs-body-bg)"] {
    background-color: #404B69 !important;
  }

  body.dark-version .card[style*="color: var(--bs-body-color)"] {
    color: #f8f9fa !important;
  }

  body.dark-version .card-header {
    background: linear-gradient(135deg, #6a007d, #cb0c9f) !important;
    border-bottom: 1px solid rgba(255,255,255,0.1) !important;
  }

  /* Mode sombre - Form controls - Surcharge des styles inline */
  body.dark-version .form-control {
    background-color: #283149 !important;
    color: #f1f1f1 !important;
    border-color: rgba(255,255,255,0.2) !important;
  }

  body.dark-version .form-control[style*="background-color: var(--bs-body-bg)"] {
    background-color: #283149 !important;
  }

  body.dark-version .form-control[style*="color: var(--bs-body-color)"] {
    color: #f1f1f1 !important;
  }

  body.dark-version .form-control:focus {
    background-color: #283149 !important;
    color: #f1f1f1 !important;
    border-color: #6a007d !important;
    box-shadow: 0 0 0 0.2rem rgba(106, 0, 125, 0.25) !important;
  }

  body.dark-version select.form-control {
    background-color: #283149 !important;
    background-image: url("data:image/svg+xml;utf8,<svg fill='white' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='20' height='20'><path d='M7 10l5 5 5-5z'/></svg>") !important;
    color: #f1f1f1 !important;
  }

  body.dark-version select.form-control option {
    background-color: #283149 !important;
    color: #f1f1f1 !important;
  }

  /* Mode sombre - Text */
  body.dark-version small.text-muted {
    color: rgba(255,255,255,0.6) !important;
  }

  body.dark-version .text-muted {
    color: rgba(255,255,255,0.7) !important;
  }

  body.dark-version ol.text-muted li,
  body.dark-version ul.text-muted li {
    color: rgba(255,255,255,0.7) !important;
  }

  /* Mode sombre - Headings et labels */
  body.dark-version h4,
  body.dark-version h5,
  body.dark-version label,
  body.dark-version .fw-bold {
    color: #ffffff !important;
  }

  body.dark-version h5[style*="color: #6a007d"] {
    color: #cb0c9f !important;
  }

  body.dark-version p {
    color: rgba(255,255,255,0.9) !important;
  }

  body.dark-version p[style*="color: var(--bs-body-color)"] {
    color: rgba(255,255,255,0.9) !important;
  }

  /* Mode sombre - Container */
  body.dark-version .container-fluid {
    background: transparent !important;
  }

  /* Mode sombre - Navigation */
  body.dark-version .navbar,
  body.dark-version .navbar-main {
    background: rgba(26, 31, 46, 0.95) !important;
    backdrop-filter: blur(10px) !important;
    box-shadow: 0 4px 16px rgba(0,0,0,0.3) !important;
  }

  body.dark-version .navbar[style*="background: rgba(255,255,255,0.95)"] {
    background: rgba(26, 31, 46, 0.95) !important;
  }

  /* Mode sombre - Breadcrumb */
  body.dark-version .breadcrumb {
    background: transparent !important;
  }

  body.dark-version .breadcrumb-item a {
    color: #cb0c9f !important;
  }

  body.dark-version .breadcrumb-item a[style*="color: #6a007d"] {
    color: #cb0c9f !important;
  }

  body.dark-version .breadcrumb-item.active,
  body.dark-version .breadcrumb-item {
    color: rgba(255,255,255,0.8) !important;
  }

  body.dark-version .breadcrumb-item.active[style*="color: #344767"],
  body.dark-version .breadcrumb-item[style*="color: #344767"] {
    color: rgba(255,255,255,0.8) !important;
  }

  /* Mode sombre - Navbar buttons et icons */
  body.dark-version .nav-link,
  body.dark-version .btn.text-body {
    color: rgba(255,255,255,0.8) !important;
  }

  body.dark-version #theme-toggle,
  body.dark-version #theme-toggle svg {
    color: rgba(255,255,255,0.8) !important;
  }

  body.dark-version #theme-toggle:hover {
    color: #ffffff !important;
  }
  
  body.dark-version .sidenav-toggler-inner,
  body.dark-version .sidenav-toggler-line {
    background-color: rgba(255,255,255,0.8) !important;
  }

  body.dark-version .sidenav-toggler-inner:hover .sidenav-toggler-line {
    background-color: #ffffff !important;
  }

  /* Mode sombre - Navbar text */
  body.dark-version .navbar-nav .nav-link {
    color: rgba(255,255,255,0.8) !important;
  }

  body.dark-version .navbar-nav .nav-link:hover {
    color: #ffffff !important;
  }
</style>
{% endblock stylesheets %}

{% block content %}
{% include 'includes/sidebar.html' %}

<main class="main-content position-relative border-radius-lg">
  {% include 'includes/navigation.html' %}

<div class="container-fluid py-4">
  <div class="row">
      <div class="col-lg-12">
        <div class="card shadow border-0"
             style="background-color: var(--bs-body-bg); color: var(--bs-body-color);">
          
          <!-- EN-T√äTE -->
          <div class="card-header text-center"
               style="background: linear-gradient(135deg, #6a007d, #cb0c9f);">
            <h4 class="mb-0 fw-bold" style="color: rgba(255,255,255,0.95);">
              Analyse de fichiers r√©seau ‚Äì Lancement d‚Äôune d√©tection
            </h4>
          </div>

          <!-- CORPS -->
          <div class="card-body px-5 py-4">
            <p class="mb-4" style="color: var(--bs-body-color);">
              Importez un fichier de trafic r√©seau pour lancer une analyse. 
              Le syst√®me analysera automatiquement les flux et d√©tectera les comportements anormaux 
              √† l‚Äôaide du mod√®le de pr√©diction s√©lectionn√©.
            </p>

            <!-- FORMULAIRE -->
            <form id="uploadForm" method="POST" enctype="multipart/form-data"
                  action="{{ url_for('home_blueprint.upload_file') }}">
              
              <!-- Mod√®le de pr√©diction -->
                        <div class="mb-3">
                <label for="model" class="label-theme fw-bold" style="color: #6a007d;">Mod√®le de pr√©diction :</label>
                <div class="input-group">
                  <select name="model" id="model" class="form-control"
                          style="appearance: none;
                                 background-color: var(--bs-body-bg);
                                 color: var(--bs-body-color);
                                 border: 1px solid rgba(0,0,0,0.1);
                                 background-image: url('data:image/svg+xml;utf8,<svg fill=\'%236a007d\' xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\' width=\'20\' height=\'20\'><path d=\'M7 10l5 5 5-5z\'/></svg>');
                                 background-repeat: no-repeat;
                                 background-position: right 1rem center;
                                 background-size: 1em;
                                 padding-right: 2.5rem;">
                    <option value="ensemble">Ensemble ‚Äì Best Hybrid Model</option>
                    <option value="xgb">XGBoost ‚Äì Gradient Boosting</option>
                    <option value="rf">Random Forest ‚Äì Forest Classifier</option>
                    <option value="dnn">DNN ‚Äì Deep Neural Network</option>
                    <option value="cnn">CNN ‚Äì Convolutional Neural Network</option>
                  </select>
            </div>
          </div>

              <!-- Fichier √† analyser -->
              <div class="mb-3">
                <label for="file" class="label-theme fw-bold" style="color: #6a007d;">Fichier √† analyser :</label>
                <input type="file" name="file" id="file" class="form-control"
                       accept=".pcap,.pcapng" required>
                <small class="text-muted" style="color: #6a007d;">Formats accept√©s : .pcap, .pcapng</small>
          </div>

              <!-- Bouton -->
            <div class="text-center mt-4">
                <button type="submit" class="btn text-white px-5 fw-bold"
                        style="background: linear-gradient(135deg, #6a007d, #cb0c9f); border: none;">
                  Lancer l‚Äôanalyse
              </button>
            </div>
            </form>
          </div>
              </div>
            </div>
          </div>

    <!-- SECTIONS D‚ÄôINFORMATION -->
    <div class="row mt-4">
              <div class="col-md-6">
        <div class="card shadow-sm border-0 h-100"
             style="background-color: var(--bs-body-bg); color: var(--bs-body-color);">
          <div class="card-body">
            <h5 class="fw-bold mb-3" style="color: #6a007d;">Comment utiliser cette section</h5>
            <ol class="text-muted">
              <li>Capturez le trafic r√©seau (fichier PCAP)</li>
              <li>Importez le fichier dans SafeNet IDS</li>
              <li>S√©lectionnez le mod√®le d‚Äôanalyse appropri√©</li>
              <li>Cliquez sur ‚ÄúLancer l‚Äôanalyse‚Äù</li>
              <li>Consultez les r√©sultats et visualisez les pr√©dictions</li>
            </ol>
  </div>
            </div>
          </div>

      <div class="col-md-6">
        <div class="card shadow-sm border-0 h-100"
             style="background-color: var(--bs-body-bg); color: var(--bs-body-color);">
          <div class="card-body">
            <h5 class="fw-bold mb-3" style="color: #6a007d;">Caract√©ristiques extraites</h5>
            <ul class="text-muted mb-0">
              <li>Dur√©e et volume des flux</li>
              <li>Comptage de paquets et d√©bits de transfert</li>
              <li>Distribution des tailles de paquets</li>
              <li>Temps inter-arriv√©es</li>
              <li>Protocole et ports utilis√©s</li>
              </ul>
          </div>
        </div>
      </div>
    </div>

  </div>

  {% include 'includes/footer.html' %}
</main>
{% endblock content %}
{% include 'includes/scripts.html' %}

{% block javascripts %}
<!-- Script de gestion du mode sombre - Optimis√© pour performance -->
<script>
(function() {
  'use strict';
  
  // Fonction pour appliquer le th√®me (sans reflow forc√©)
  function applyTheme(isDark) {
    if (isDark) {
      document.body.classList.add('dark-version');
    } else {
      document.body.classList.remove('dark-version');
    }
  }

  // Appliquer le th√®me au chargement
  function initTheme() {
    const savedTheme = localStorage.getItem('theme');
    applyTheme(savedTheme === 'dark');
  }

  // √âcouter les changements du toggle directement (plus rapide que MutationObserver)
  function setupThemeToggle() {
    const themeToggle = document.getElementById('theme-toggle');
    if (themeToggle) {
      // Utiliser capture pour intercepter avant le script de navigation
      themeToggle.addEventListener('click', function() {
        // Petit d√©lai pour laisser le script de navigation mettre √† jour localStorage
        setTimeout(function() {
          const currentTheme = localStorage.getItem('theme');
          applyTheme(currentTheme === 'dark');
        }, 10);
      }, true);
    }
  }

  // √âcouter les changements dans localStorage (synchronisation entre onglets uniquement)
  function setupStorageListener() {
    window.addEventListener('storage', function(e) {
      if (e.key === 'theme') {
        applyTheme(e.newValue === 'dark');
      }
    });
  }

  // Initialisation optimis√©e
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      initTheme();
      setupThemeToggle();
      setupStorageListener();
      });
    } else {
    // DOM d√©j√† charg√©
    initTheme();
    setupThemeToggle();
    setupStorageListener();
  }
})();
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("uploadForm");
    form.addEventListener("submit", async function (e) {
      e.preventDefault();
  
      const formData = new FormData(form);
      const submitButton = form.querySelector("button[type='submit']");
      submitButton.disabled = true;
      submitButton.innerHTML = "Analyse en cours... ‚è≥";
  
      try {
        // √âtape 1Ô∏è‚É£ : Upload du fichier PCAP
        const uploadResponse = await fetch("{{ url_for('home_blueprint.upload_file') }}", {
          method: "POST",
          body: formData,
        });
        const uploadData = await uploadResponse.json();
  
        if (!uploadData.success) {
          alert("‚ö†Ô∏è Erreur lors du t√©l√©versement : " + (uploadData.error || "inconnue"));
          submitButton.disabled = false;
          submitButton.innerHTML = "Lancer l‚Äôanalyse";
          return;
        }
  
        // √âtape 2Ô∏è‚É£ : Lancer l‚Äôanalyse
        const analyzeResponse = await fetch("/analyze-data", { method: "POST" });
        const analyzeData = await analyzeResponse.json();
  
        if (analyzeData.success) {
          // √âtape 3Ô∏è‚É£ : Redirection vers la page d‚Äôanalyse
          window.location.href = "/analysis";
        } else {
          alert("‚ö†Ô∏è Erreur lors de l‚Äôanalyse : " + (analyzeData.error || "inconnue"));
          submitButton.disabled = false;
          submitButton.innerHTML = "Lancer l‚Äôanalyse";
        }
  
      } catch (error) {
        console.error("Erreur r√©seau :", error);
        alert("üö® Une erreur s‚Äôest produite : " + error.message);
        submitButton.disabled = false;
        submitButton.innerHTML = "Lancer l‚Äôanalyse";
      }
    });
  });
  </script>
  
{% endblock javascripts %}


