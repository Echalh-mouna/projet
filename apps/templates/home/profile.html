{% extends 'layouts/base.html' %}

{% set segment = 'profile' %}

{% block title %} Gestion des informations personnelles {% endblock title %}

{% block page_name %}Profil{% endblock %}

{% block stylesheets %}
<style>
  .profile-card {
    background: white;
    border: 1px solid #dee2e6;
    box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
  }
  
  .profile-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
  }
  
  .profile-header {
    background: linear-gradient(135deg, #6a007d 0%, #cb0c9f 100%);
    color: white;
    border-radius: 18px 18px 0 0;
    padding: 0.75rem 1rem;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 64px;
  }
  
  .profile-header h5 {
    margin-top: 0 !important;
    margin-bottom: 0 !important;
  }

  .btn-profile {
    background: linear-gradient(135deg, #6a007d 0%, #cb0c9f 100%);
    border: none;
    border-radius: 8px;
    padding: 12px 24px;
    color: white;
    font-weight: 600;
    transition: all 0.3s ease;
  }
  
  .btn-profile:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(106, 0, 125, 0.3);
  }
  
  .current-password {
    background-color: #f8f9fa !important;
    cursor: not-allowed;
  }
  
  .toast {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    min-width: 300px;
  }
</style>
{% endblock stylesheets %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-12 col-md-8 col-lg-6">
            <!-- Formulaire d'informations personnelles -->
            <div class="card mb-4 profile-card">
                <div class="card-header pb-0 profile-header">
                    <h5 class="mb-0 mt-0" style="color: white;">Mes informations personnelles</h5>
                </div>
                <div class="card-body px-4 pt-3 pb-3">
                    <form method="POST" action="{{ url_for('authentication_blueprint.update_profile') }}">
                        {{ update_profile_form.hidden_tag() }}
                        <div class="mb-3">
                            <label class="form-label">Nom d'utilisateur</label>
                            {{ update_profile_form.username(class="form-control", value=current_user.username, readonly=True) }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nom complet</label>
                            {{ update_profile_form.full_name(class="form-control", value=current_user.full_name or '') }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            {{ update_profile_form.email(class="form-control", value=current_user.email, readonly=True) }}
                        </div>

                        <button type="submit" name="update_profile" class="btn btn-profile" onclick="showUpdateToast()">Mettre à jour</button>
                    </form>
                </div>
            </div>
            <!-- Formulaire de changement de mot de passe -->
            <div class="card profile-card">
                <div class="card-header pb-0 profile-header">
                    <h5 class="mb-0 mt-0" style="color: white;">Changer le mot de passe</h5>
                </div>
                <div class="card-body px-4 pt-3 pb-3">
                    {% if password_message %}
                        <div class="alert alert-info">{{ password_message }}</div>
                    {% endif %}
                    <form method="POST" action="{{ url_for('authentication_blueprint.change_password') }}">
                        {{ change_password_form.hidden_tag() }}

                        <div class="mb-3">
                            <label class="form-label">Mot de passe actuel</label>
                            <input type="password" class="form-control current-password" value="••••••••••••" disabled readonly>
                        </div>

                        <div class="mb-3">
                            {{ change_password_form.new_password.label(class="form-label") }}
                            {{ change_password_form.new_password(class="form-control", placeholder="Nouveau mot de passe", type="password") }}
                            {% if change_password_form.new_password.errors %}
                                <div class="text-danger">
                                    {% for error in change_password_form.new_password.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            {{ change_password_form.confirm_password.label(class="form-label") }}
                            {{ change_password_form.confirm_password(class="form-control", placeholder="Confirmer le mot de passe", type="password") }}
                            {% if change_password_form.confirm_password.errors %}
                                <div class="text-danger">
                                    {% for error in change_password_form.confirm_password.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <button type="submit" name="change_password" class="btn btn-profile" onclick="showPasswordToast()">Changer le mot de passe</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block javascripts %}
<script>
function showToast(message, type) {
  const toast = document.createElement('div');
  toast.className = `alert alert-${type} alert-dismissible fade show toast`;
  toast.innerHTML = `
    ${message}
    <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    if (toast.parentNode) {
      toast.remove();
    }
  }, 3000);
}

function showUpdateToast() {
  setTimeout(() => {
    showToast('Profil mis à jour avec succès!', 'success');
  }, 100);
}

function showPasswordToast() {
  setTimeout(() => {
    showToast('Mot de passe changé avec succès!', 'success');
  }, 100);
}
</script>
{% endblock javascripts %}